$(document).ready(function() {

  $('select').material_select();
  $( "#datepicker" ).datepicker({
     dateFormat: 'yy-mm-dd',
     disabled: true
   });
  $('#site_select').on('change',function(){
     if ($('#site_select').val() != ""){
       $("#datepicker" ).datepicker('enable');
     } else {
       $("#datepicker" ).datepicker('enable');
       $("#table-shift").css('display','none');
       $("#datepicker").datepicker('setDate', null);
     }
   });
   $("input#datepicker").on('change',function(){

     if ($(this).val() != ""){
        var firstDay = $(this).val(),
            site = $('#site_select').val(),
            fdate = $(this).val().split("-"),
            fdate = new Date(fdate[0],fdate[1]-1,fdate[2],0,0,0),
            days = ["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],
            day_num = fdate.getDay();

       $.ajax({
            url: "shifts/found",
            type: "POST",
            dataType: "json",
            data: {'date': firstDay, 'site': site},
            complete: function() {},
            success: function(data, textStatus) {
                if (data != ""){
                  // alert(data[0]['guard_id']);
                  $('#table-shift').css('display','block');
                  $('#date-1').html(days[day_num] + " " + firstDay);
                }

              },
              error: function() {
                alert("Ajax error!")
              }
       });
     }})
   calculate();
   $('input.upload_button').on('change', function(){
     if($(this).val() != '') {
       $('#upload_a').removeClass('disabled');
     } else {$('#upload_a').addClass('disabled');}
   });
 });
  /******** FUNCTION MISLEY ***********/
  function day_per_week(firtsday){

  }
  function calculate(){
    $("#listing-shifts tbody tr").each(function (index){
      calculate_hours_total(index);
    });
  }
  function calculate_hours_total(row){
    var  total_week , total, i, h_on;

      total_week = [0,0];
      for(i=1;i<8;i++){
        var time = convert_time_msecond(calculate_hours(i,row));
        var h_on = time.split(":");
        h_on[0]=(isNaN(parseInt(h_on[0])))?0:parseInt(h_on[0]);
        h_on[1]=(isNaN(parseInt(h_on[1])))?0:parseInt(h_on[1]);
        total_week[0] = total_week[0] + h_on[0];
        total_week[1] = total_week[1] + h_on[1];
      }
        var text = (total_week[0] < 10 ? "0" + total_week[0] : total_week[0]) + ":" + (total_week[1] < 10 ? "0" + total_week[1] : total_week[1]) ;
        $("#tr-"+row+" #total_week").text(text);
    }

  function calculate_hours(day,index){
    var day_on = new Date(),
        day_off = new Date(),
        diff = 0,
        h_on = $("#tr-"+index+" input[name='time"+day+"-on']").val().split(":") ,
        h_off = $("#tr-"+index+" input[name='time"+day+"-off']").val().split(":");

    if ((h_on.length > 1) && (h_off.length > 1)) {
      for(i=0;i<3;i++){
        h_on[i]=(isNaN(parseInt(h_on[i])))?0:parseInt(h_on[i])
        h_off[i]=(isNaN(parseInt(h_off[i])))?0:parseInt(h_off[i])
      }
      day_on.setHours(h_on[0], h_on[1], 0);
      day_off.setHours(h_off[0], h_off[1], 0);

      diff = day_off - day_on;
      if ( diff != 0 ){
        $("#tr-"+index+" #"+day+"-total").text(convert_time_msecond(diff));
      } else {
        $("#tr-"+index+" #"+day+"-total").text("");
      }

    }
    return diff;
  }

  function convert_time_msecond(msecond){
      var msecPerMinute = 1000 * 60;
      var msecPerHour = msecPerMinute * 60;
      var msecPerDay = msecPerHour * 24;
      // Calculate how many days the dif contains. Subtract that
      var days = Math.floor(msecond / msecPerDay ) ;
      msecond = msecond - (days * msecPerDay );
      // Calculate the hours, minutes, and seconds.
      var hours = Math.floor(msecond / msecPerHour );
      msecond = msecond - (hours * msecPerHour );

      var minutes = Math.floor(msecond / msecPerMinute );
      msecond = msecond - (minutes * msecPerMinute );

      var seconds = Math.floor(msecond / 1000 );
      var total_hours = days > 0 ? ( Math.abs(days) * 24 + Math.abs(hours) ) : hours;
      return (total_hours < 10 ? "0" + total_hours : total_hours) + ":" + (minutes < 10 ? "0" + minutes : minutes) ;
  }
